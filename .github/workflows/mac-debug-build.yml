name: ODBC Driver for Mac (Debug)

on:
  workflow_dispatch:

env:
  CI_OUTPUT_PATH: "ci-output"
  ODBC_LIB_PATH: "./build/odbc/lib"
  ODBC_BIN_PATH: "./build/odbc/bin"
  ODBC_BUILD_PATH: "./build/odbc/build"
  DOCUMENTDB_HOME: "./build/odbc/bin"

jobs:
  build-mac:
    runs-on: macos-11
    env: 
      NOT_CONNETECD: 1
    steps:
    - uses: actions/checkout@v2
    # - name: run-cppcheck
    #   run: |
    #     brew install cppcheck
    #     sh run_cppcheck.sh
    # - name: upload-cppcheck-results
    #   if: failure()
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: cppcheck-results
    #     path: cppcheck-results.log
    - name: get-dependencies
      run: |
        brew install unixodbc
        brew install cmake
        brew install openssl
        brew install boost
        brew install mongo-cxx-driver
    - name: set-PATH
      run: |
        export PATH=/Library/Developer/CommandLineTools/usr/bin:$PATH

    - name: Cache DocumentDB JDBC JAR
      id: cache-documentdb-jdbc-jar
      uses: actions/cache@v3
      with:
        path: | 
          cache/jar
        key: cache-documentdb-jdbc-jar-${{env.JDBC_DRIVER_VERSION}}

    - name: Download DocumentDB JDBC JAR
      if: steps.cache-documentdb-jdbc-jar.outputs.cache-hit != 'true'
      run: |
        mkdir -p cache/jar
        cd cache/jar
        wget https://github.com/aws/amazon-documentdb-jdbc-driver/releases/download/vd{{env.JDBC_DRIVER_VERSION}}/documentdb-jdbc-${{env.JDBC_DRIVER_VERSION}}-all.jar

    - name: Install DocumentDB JDBC JAR
      run: |
        mkdir -p ${{env.ODBC_BIN_PATH}}/libs
        cp cache/jar/documentdb-jdbc-${{env.JDBC_DRIVER_VERSION}}-all.jar ${{env.ODBC_BIN_PATH}}/libs

    - name: configure-and-build-driver
      run: |
        ./build_mac_debug64.sh
    # - name: prepare-dsn
    #   run: |
    #     sudo mkdir /Library/ODBC
    #     sudo mv ./src/Tests/Tests/odbc.ini /Library/ODBC
    #     mkdir ${{ github.workspace }}/odbc-logs
    - name: register-odbc-driver
      run: |
        chmod +x scripts/register_driver_macos.sh
        ./scripts/register_driver_macos.sh
    - name: Setup MongoDB
      run: |
        chmod +x ./src/odbc-test/scripts/reinstall_mongodb_mac.sh
        ./src/odbc-test/scripts/reinstall_mongodb_mac.sh
    - name: Import test data
      run: |
        chmod +x ./src/odbc-test/scripts/import_test_data.sh
        ./src/odbc-test/scripts/import_test_data.sh
    # - name: run-tests
    #   run: |
    #     ./build/odbc/bin/tests --gtest_output="xml:report.xml"
    - name: upload-test-report
      if: always()
      uses: EnricoMi/publish-unit-test-result-action/composite@v1.30
      with:
        check_name: "MacOS Big Sur 11 Debug Build Unit Test Results Check"
        comment_title: "MacOS Big Sur 11 Debug Build Unit Test Results"
        files: ./odbc_test_result.xml
    # - name: print-memory-leak-logs
    #   if: always()
    #   run: |
    #     cat ./leaks_*
    # - name: upload-test-logs
    #   if: always()
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: test-logs-mac64
    #     path: |
    #       ${{ github.workspace }}/odbc-logs/
    #       ${{ github.workspace }}/leaks_
