name: ODBC Driver for Mac

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  CI_OUTPUT_PATH: "ci-output"
  ODBC_LIB_PATH: "${{github.workspace}}/build/odbc/lib"
  ODBC_BIN_PATH: "${{github.workspace}}/build/odbc/bin"
  ODBC_BUILD_PATH: "${{github.workspace}}/build/odbc/build"
  DOCUMENTDB_HOME: "${{github.workspace}}/build/odbc/bin"
  DOC_DB_KEYPAIR: ${{secrets.DOC_DB_KEYPAIR}}
  DOC_DB_USER_NAME: ${{secrets.DOC_DB_USER_NAME}}
  DOC_DB_PASSWORD: ${{secrets.DOC_DB_PASSWORD}}
  DOC_DB_USER: ${{secrets.DOC_DB_USER}}
  DOC_DB_HOST: ${{secrets.DOC_DB_HOST}}
  DOC_DB_LOCAL_PORT: 27019
  DOC_DB_REMOTE_PORT: 27017
  DOC_DB_PRIV_KEY_FILE: ~/certs/docdb-sshtunnel.pem

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
    - name: Get Java distribution
      uses: actions/setup-java@v2
      with:
        distribution: 'temurin'
        java-version: '17'
        architecture: x64
    # - name: run-cppcheck
    #   run: |
    #     brew install cppcheck
    #     sh run_cppcheck.sh
    # - name: upload-cppcheck-results
    #   if: failure()
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: cppcheck-results
    #     path: cppcheck-results.log
    - name: Extract key-pair into file
      run: |
        mkdir ~/certs
        echo "${{env.DOC_DB_KEYPAIR}}" > ${{env.DOC_DB_PRIV_KEY_FILE}}
        chmod 400 ${{env.DOC_DB_PRIV_KEY_FILE}}

    - name: get-dependencies
      run: |
        brew install unixodbc
        brew install cmake
        brew install openssl
        brew install boost
    - name: configure-and-build-driver
      run: |
        ./build_mac_release64.sh
      env:
        OPENSSL_ROOT_DIR: /usr/local/opt/openssl
    - name: code-review
      uses: ZedThree/clang-tidy-review@v0.7.0
      id: code-review
    # - name: prepare-dsn
    #   run: |
    #     sudo mkdir /Library/ODBC
    #     sudo cp ./src/Tests/Tests/odbc-mac.ini /Library/ODBC/odbc.ini
    #     sudo cp ./src/Tests/Tests/odbcinst-mac.ini /Library/ODBC/odbcinst.ini
    #     mkdir ${{ github.workspace }}/odbc-logs
    - name: register-odbc-driver
      run: |
        echo "[Apache Ignite]"                                      > "${{env.ODBC_LIB_PATH}}/ignite-odbc-install.ini"
        echo "Description=Apache Ignite"                           >> "${{env.ODBC_LIB_PATH}}/ignite-odbc-install.ini"
        echo "Driver=${{env.ODBC_LIB_PATH}}/libignite-odbc.dylib"  >> "${{env.ODBC_LIB_PATH}}/ignite-odbc-install.ini"
        echo "Setup=${{env.ODBC_LIB_PATH}}/libignite-odbc.dylib"   >> "${{env.ODBC_LIB_PATH}}/ignite-odbc-install.ini"
        echo "DriverODBCVer=03.00"                                 >> "${{env.ODBC_LIB_PATH}}/ignite-odbc-install.ini"
        echo "FileUsage=0"                                         >> "${{env.ODBC_LIB_PATH}}/ignite-odbc-install.ini"
        odbcinst -i -d -f "${{env.ODBC_LIB_PATH}}/ignite-odbc-install.ini"
    - name: run-tests
      run: |
        ./build/odbc/bin/ignite-odbc-tests
    # - name: upload-test-report
    #   if: failure()
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: test-result-macos
    #     path: ${{ github.workspace }}/report.xml
    # - name: print-memory-leak-logs
    #   if: always()
    #   run: |
    #     cat ./leaks_*
    # - name: upload-test-logs
    #   if: failure()
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: test-logs-mac64
    #     path: |
    #       ${{ github.workspace }}/odbc-logs/
    #       ${{ github.workspace }}/leaks_
    # - name: test
    #   run: |
    #     bash ./run_test_runner.sh
    # - name: build-installer
    #   if: success()
    #   run: |
    #     cd cmake-build64
    #     cmake ../src
    #     make
    #     cpack .
    #     cd ..
    # - name: create-output
    #   if: success()
    #   run: |
    #     mkdir build-output
    #     mkdir test-output
    #     mkdir installer
    #     cp ./build/odbc/lib/*.dylib build-output/
    #     cp ./build/odbc/lib/*.a build-output/
    #     cp ./cmake-build64/*.pkg installer/
    # - name: upload-build
    #   if: success()
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: mac64-build
    #     path: build-output
    # - name: upload-installer
    #   if: success()
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: mac64-installer
    #     path: installer
    # - name: upload-test-results
    #   if: success()
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: mac-test-results
    #     path: test-output